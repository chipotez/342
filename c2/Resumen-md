
===============================================================                                                             =
=                         SeccionI                            =
=          Ejercicio guiado: cokpit                           =
=                                                             =
===============================================================



===============================================================                                                             =
=                         SeccionI                            =
=          Ejercicio guiado: Monitoreo de sistemas            =
=                                                             =
===============================================================

En este trabajo de laboratorio, monitoreará el rendimiento del sistema actual e histórico a través de Performance Co-Pilot.

Recursos
Archivos	/root/cpuidle
Máquinas servera

Deberá poder mostrar los indicadores de rendimiento actuales e históricos en un sistema a través de Performance Co-Pilot.

Inicie sesión en servera como el usuario root.

En este ejercicio, instalará y configurará el software de Performance Co-Pilot en servera. 
Utilizará las utilidades proporcionadas por el software para recopilar estadísticas
de rendimiento actuales del sistema. También aprovechará la función de archivo del software y 
recuperará estadísticas de rendimiento históricas.


Instale el software Performance Co-Pilot en servera al instalar el paquete pcp.

[root@servera ~]# yum install -y pcp
Inicie y habilite el servicio pmcd para habilitar la recopilación de métricas de rendimiento.

[root@servera ~]# systemctl start pmcd
[root@servera ~]# systemctl enable pmcd
[root@servera ~]# systemctl status pmcd
[root@servera ~]# systemctl start pmlogger
[root@servera ~]# systemctl enable pmlogger
[root@servera ~]# systemctl status pmlogger

Consulte el daemon pmcd para mostrar el tiempo de inactividad por CPU para un minuto.
[root@servera ~]# pmval -T 1minute kernel.percpu.cpu.idle

Recupere la ubicación del registro de archivos en el que el proceso pmlogger principal está escribiendo.
[root@servera ~]# pcp | grep 'primary logger'
 pmlogger: primary logger: /var/log/pcp/pmlogger/servera.lab.example.com/20151211.08.28

A través del resultado del comando anterior, determine la iteración más reciente del registro de archivos al examinar los datos de fecha y hora contenidos en el nombre del archivo.
[root@servera ~]# ls -1 /var/log/pcp/pmlogger/servera.lab.example.com/20151211.08.28.[0-9]* | tail -1
/var/log/pcp/pmlogger/servera.lab.example.com/20151211.08.28.0

Use el comando pmval para obtener estadísticas históricas del tiempo de inactividad por CPU en intervalos de un minuto desde el registro de archivo más reciente. Guarde el resultado en el archivo /root/cpuidle.
[root@servera ~]# pmval -t1minute kernel.percpu.cpu.idle -a /var/log/pcp/pmlogger/servera.lab.example.com/20151211.08.28.0 > /root/cpuidle

===============================================================                                                             =
=                         SeccionII                           =
=     Ejercicio : Configuracion de Registros Remotos          =
=                                                             =
===============================================================
===============================================================
===============================================================
===============================================================


Configurará el registro de logs en un host de registro central.

Archivos	
/etc/rsyslog.conf
/etc/logrotate.d/syslog

Máquinas	
servera
serverb

Resultados
Deberá poder centralizar el registro de sistemas remotos en un host de registro central.


En servera
Configure el servicio rsyslog para que funcione como un host de registro central. 
Configure el host para aceptar la entrega de mensajes de hosts remotos a través de TCP.
Cree una nueva regla que escriba los mensajes de syslog por cada host en subdirectorios separados en /var/log/loghost. 
Los subdirectorios recibirán el nombre de host de cada host. 
Dentro del subdirectorio de cada host, se conservará un archivo de registro separado para los mensajes de cada instalación de syslog. 
Para un mejor rendimiento, configure el registro para que no se realice una sincronización después de que se registra cada mensaje. 
Configure la rotación de registros para los nuevos archivos de registro.

Configure serverb para el registro remoto del host de registro central. 
Pruebe la configuración al generar un mensaje de prueba y verificar su presencia en el registro adecuado en servera.

1 .- Verifique que el servicio rsyslog esté en ejecución y habilitado para iniciarse en el arranque.
[root@servera ~]# systemctl is-active rsyslog
[root@servera ~]# systemctl is-enabled rsyslog

2 .- Habilite la recepción de syslog TCP en /etc/rsyslog.conf al quitar los comentarios de las siguientes líneas.
$ModLoad imtcp
$InputTCPServerRun 514

3 .- En la sección "#### RULES ####", crear regla para los nombres de archivos de registro dinámicos y, luego, 
cree una regla para usar el nombre de archivo dinámico para separar los mensajes de registro por nombre de host e instalación.

$template DynamicFile,"/var/log/loghost/%HOSTNAME%/%syslogfacility-text%.log"
*.* -?DynamicFile


4 .- Reinicie el servicio rsyslog para que se apliquen los cambios de configuración.
[root@servera ~]# systemctl restart rsyslog

5 .- Agregue la siguiente entrada a la lista de archivos en el archivo de configuración /etc/logrotate.d/syslog para que 
se coloquen los nuevos archivos de registro en el programa de rotación de registros.
/var/log/loghost/*/*.log

6 .- Habilite el tráfico entrante en el puerto TCP 514.
[root@servera ~]# firewall-cmd --add-port=514/tcp --permanent
[root@servera ~]# firewall-cmd --reload

En serverb
1 .- A gregue la siguiente regla a /etc/rsyslog.conf para que todos los mensajes de syslog se entreguen de manera remota a servera a través de TCP en el puerto 514.
*.* @@servera.lab.example.com:514

2 .- Reinicie el servicio rsyslog para que se apliquen los cambios de configuración de serverb.
[root@serverb ~]# systemctl restart rsyslog

3 .- G enere un par de mensajes de syslog con diferentes instalaciones.

[root@serverb ~]# logger -p user.info "Test user.info message from serverb"
[root@serverb ~]# logger -p authpriv.crit "Test authpriv.crit message from serverb"

En servera 
1 .- Verifique que el mensaje de syslog aparezca en los archivos adecuados de /var/log/loghost/serverb.

[root@servera ~]# grep 'user\.info' /var/log/loghost/serverb/user.log
[root@servera ~]# grep 'authpriv\.crit' /var/log/loghost/serverb/authpriv.log

===============================================================                                                             =
=                         SeccionIII                          =
=     Ejercicio : Configuration management                    =
=                                                             =
===============================================================
===============================================================
===============================================================
===============================================================

Ejercicio guiado: Uso de gestión de configuraciones	
En este trabajo de laboratorio, configurará un sistema para la gestión de configuraciones a través de Puppet.

Recursos
Archivos	/etc/puppet/puppet.conf
Máquinas	
servera

serverb

Resultados
Deberá poder instalar y configurar Puppet en un sistema y, luego, utilizar el agente de Puppet para configurar el servicio web en el sistema.

Prepare sus sistemas para este ejercicio ejecutando el comando lab puppet setup en su máquina workstation. Esto configurará los repositorios necesarios en sus sistemas y configurará servera para que actúe como el Puppet maestro.

[student@workstation ~]$ lab puppet setup
Instale el software del agente de Puppet en serverb para implementarlo como el cliente de Puppet.

[root@serverb ~]# yum install -y puppet
Configure el agente de Puppet para señalar al Puppet maestro, servera.lab.example.com, al agregar la siguiente entrada a la sección agent del archivo de configuración /etc/puppet/puppet.conf.

server = servera.lab.example.com
Compruebe si el paquete httpd está instalado en este sistema.

[root@serverb ~]# rpm -q httpd
package httpd is not installed
Habilite el servicio puppet para que el agente de Puppet se inicie en el arranque.

[root@serverb ~]# systemctl enable puppet
Created symlink from /etc/systemd/system/multi-user.target.wants/puppet.service to /usr/lib/systemd/system/puppet.service.
En la ventana de un terminal separado, utilice el comando journalctl para monitorear las nuevas entradas de registro generadas por el agente de Puppet.

[root@serverb ~]# journalctl -ef
En la ventana del terminal original, inicie el servicio puppet. El sistema se registrará con el Puppet maestro y recuperará y aplicará su configuración.

[root@serverb ~]# systemctl start puppet
Observe las actividades del agente de Puppet al monitorear las nuevas entradas de registro que aparecen en el diario (journal) del sistema.

Jan 12 23:13:42 serverb.lab.example.com systemd[1]: Started Puppet agent.
Jan 12 23:13:42 serverb.lab.example.com systemd[1]: Starting Puppet agent...
Jan 12 23:13:43 serverb.lab.example.com puppet-agent[1579]: Starting Puppet client version 3.6.2
Jan 12 23:13:46 serverb.lab.example.com yum[1741]: Installed: apr-1.4.8-3.el7.x86_64
Jan 12 23:13:46 serverb.lab.example.com yum[1741]: Installed: apr-util-1.5.2-6.el7.x86_64
Jan 12 23:13:47 serverb.lab.example.com yum[1741]: Installed: httpd-tools-2.4.6-40.el7.x86_64
Jan 12 23:13:47 serverb.lab.example.com yum[1741]: Installed: mailcap-2.1.41-2.el7.noarch
Jan 12 23:13:47 serverb.lab.example.com useradd[1751]: new group: name=apache, GID=48
Jan 12 23:13:47 serverb.lab.example.com useradd[1751]: new user: name=apache, UID=48, GID=48, home=/usr/share/httpd, shell=/sbin/nologin
Jan 12 23:13:49 serverb.lab.example.com systemd[1]: Reloading.
Jan 12 23:13:49 serverb.lab.example.com yum[1741]: Installed: httpd-2.4.6-40.el7.x86_64
Jan 12 23:13:50 serverb.lab.example.com puppet-agent[1599]: (/Stage[main]/Main/Node[serverb.lab.example.com]/Package[httpd]/ensure) created
Jan 12 23:13:50 serverb.lab.example.com systemd[1]: Starting The Apache HTTP Server...
Jan 12 23:13:50 serverb.lab.example.com systemd[1]: Started The Apache HTTP Server.
Jan 12 23:13:50 serverb.lab.example.com systemd[1]: Reloading.
Jan 12 23:13:50 serverb.lab.example.com puppet-agent[1599]: (/Stage[main]/Main/Node[serverb.lab.example.com]/Service[httpd]/ensure) ensure changed 'stopped' to 'running'
Jan 12 23:13:50 serverb.lab.example.com puppet-agent[1599]: Finished catalog run in 5.66 seconds
Compruebe que la configuración aplicada resultó en la instalación de httpdy la habilitación y el inicio del servicio httpd.

[root@serverb ~]# rpm -q httpd
httpd-2.4.6-40.el7.x86_64
[root@serverb ~]# systemctl is-active httpd
active
[root@serverb ~]# systemctl is-enabled httpd
enabled
Evalúe su trabajo y, luego, realice una limpieza en sus sistemas para el próximo ejercicio.

Evalúe su trabajo.

[student@workstation ~]$ lab puppet grade
Realice una limpieza en sus sistemas para el próximo ejercicio.

[student@workstation ~]$ lab puppet reset



